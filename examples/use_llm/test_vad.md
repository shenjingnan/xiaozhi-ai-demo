# VAD 功能测试指南

## 测试目的

验证 VADNet 语音活动检测模型是否正常工作，以及语音结束检测的准确性。

## 测试环境

- **硬件**：ESP32-S3-DevKitC-1 + INMP441麦克风 + MAX98357A功放
- **软件**：已烧录包含VAD功能的固件
- **网络**：WiFi连接正常，服务端运行中

## 测试步骤

### 1. 检查VAD模型加载状态

启动设备后，通过串口监控查看以下日志：

```
✓ VAD语音活动检测模型初始化成功
- VAD模型: 已启用
- 语音结束检测: VAD智能检测
```

**预期结果**：
- 如果看到上述日志，说明VAD模型加载成功
- 如果看到"VAD模型初始化失败"，系统会回退到传统方法

### 2. 基本语音交互测试

#### 测试用例1：短语音测试
1. 说出唤醒词："你好小智"
2. 听到欢迎音频后，说："今天天气怎么样"（约2秒）
3. 停止说话，等待系统响应

**预期结果**：
- 系统应在停止说话后约1秒内检测到语音结束
- 日志显示："VAD检测到语音结束，静音持续 1xxx 毫秒"

#### 测试用例2：长语音测试
1. 说出唤醒词："你好小智"
2. 说一段较长的话："请帮我介绍一下今天的天气情况，包括温度、湿度和风力等详细信息"（约5-8秒）
3. 停止说话，等待系统响应

**预期结果**：
- 系统能够正确识别整段语音
- 在停止说话后约1秒内检测到语音结束

#### 测试用例3：间断语音测试
1. 说出唤醒词："你好小智"
2. 说话时故意停顿："今天...（停顿0.5秒）...天气怎么样"
3. 停止说话，等待系统响应

**预期结果**：
- 短暂停顿不应触发语音结束检测
- 只有在真正停止说话后才检测到语音结束

### 3. 本地命令词测试

#### 测试用例4：本地命令测试
1. 说出唤醒词："你好小智"
2. 说出本地命令："帮我开灯"
3. 观察LED灯状态和音频反馈

**预期结果**：
- 系统立即识别本地命令，不等待VAD检测
- LED灯点亮，播放确认音频

### 4. 噪音环境测试

#### 测试用例5：背景噪音测试
1. 在有轻微背景噪音的环境下进行测试
2. 重复测试用例1和2
3. 观察VAD检测的准确性

**预期结果**：
- VAD应能区分语音和背景噪音
- 不应因背景噪音误触发或延迟检测

### 5. 边界条件测试

#### 测试用例6：极短语音测试
1. 说出唤醒词："你好小智"
2. 说一个字："好"
3. 立即停止说话

**预期结果**：
- 系统应能检测到极短的语音
- 正确判断语音结束

#### 测试用例7：极长语音测试
1. 说出唤醒词："你好小智"
2. 连续说话超过10秒
3. 停止说话

**预期结果**：
- 系统应能处理长时间语音
- 不会因为缓冲区满而提前停止

## 性能对比测试

### 传统方法 vs VAD方法

可以通过修改代码临时禁用VAD来对比两种方法：

```c
// 在 add_audio_to_buffer_with_vad 函数中
// 注释掉 VAD 检测部分，强制使用传统方法
return add_audio_to_buffer_traditional(buffer, samples);
```

**对比指标**：
- 响应速度：VAD方法应比传统方法快约1秒
- 准确性：VAD方法应减少误触发
- 用户体验：VAD方法应更自然

## 故障排除

### 常见问题

1. **VAD模型加载失败**
   - 检查sdkconfig配置
   - 确认模型文件已正确烧录
   - 查看内存使用情况

2. **检测过于敏感**
   - 调整VAD模式（VAD_MODE_0到VAD_MODE_4）
   - 增加最小静音持续时间

3. **检测不够敏感**
   - 降低VAD模式等级
   - 减少最小静音持续时间
   - 检查麦克风音量

### 调试日志

关键日志信息：
```
VAD检测到语音结束，静音持续 1200 毫秒
准备发送音频到服务端处理...
```

## 测试报告模板

### 测试环境
- 设备型号：
- 固件版本：
- 测试时间：
- 测试环境：

### 测试结果

| 测试用例 | 预期结果 | 实际结果 | 通过/失败 | 备注 |
|---------|---------|---------|----------|------|
| 短语音测试 | 1秒内检测结束 | | | |
| 长语音测试 | 正确处理长语音 | | | |
| 间断语音测试 | 不误触发 | | | |
| 本地命令测试 | 立即响应 | | | |
| 噪音环境测试 | 抗噪音干扰 | | | |
| 极短语音测试 | 检测极短语音 | | | |
| 极长语音测试 | 处理长语音 | | | |

### 性能数据

- 平均响应时间：
- 检测准确率：
- 误触发率：
- 用户满意度：

### 问题和建议

记录测试过程中发现的问题和改进建议。
