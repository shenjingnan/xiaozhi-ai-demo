# 智能语音助手使用指南

## 功能概述

本项目实现了一个完整的智能语音助手系统，具备以下功能：

1. **语音唤醒**：支持"你好小智"唤醒词
2. **本地命令识别**：支持"帮我开灯"、"帮我关灯"、"拜拜"等本地命令
3. **VAD智能检测**：使用VADNet深度学习模型智能检测语音活动，准确判断用户说话结束时机
4. **云端AI对话**：非命令词语音会发送到云端千问大模型进行处理
5. **语音反馈**：所有操作都有相应的语音反馈

## 工作流程

1. 用户说"你好小智"唤醒设备
2. 设备播放欢迎音频，开始录制用户语音
3. 系统同时进行本地命令词识别和音频录制
4. 如果识别到本地命令词（如"帮我开灯"），直接执行相应操作
5. **VAD智能检测**：使用VADNet模型检测语音活动，当检测到1秒静音时自动停止录制
6. 将录制的音频发送到云端服务器进行处理
7. 云端服务器进行语音识别、AI推理、语音合成，返回音频回复
8. 设备播放云端返回的音频回复
9. 返回等待唤醒状态

## 硬件要求

- ESP32-S3-DevKitC-1开发板（需要PSRAM版本）
- INMP441数字麦克风
- MAX98357A数字功放
- 扬声器
- LED灯（可选）

## 硬件连接

### INMP441麦克风连接
- VDD -> 3.3V
- GND -> GND
- SD -> GPIO6
- WS -> GPIO4
- SCK -> GPIO5

### MAX98357A功放连接
- DIN -> GPIO7
- BCLK -> GPIO15
- LRC -> GPIO16
- VIN -> 3.3V
- GND -> GND

### LED灯连接（可选）
- 正极 -> GPIO21
- 负极 -> GND

## 软件配置

### 1. 配置WiFi
参考 `WIFI_CONFIG.md` 文件配置WiFi连接参数。

### 2. 启动Python服务端
```bash
cd server
pip install -r requirements.txt
python server.py
```

### 3. 配置千问API
在 `server/.env` 文件中设置：
```
DASHSCOPE_API_KEY=your_api_key_here
```

### 4. 编译和烧录固件
```bash
# 设置ESP-IDF环境
source ~/esp/esp-idf/export.sh

# 编译
idf.py build

# 烧录
idf.py flash

# 监控串口输出
idf.py monitor
```

## 使用方法

1. 确保硬件连接正确，固件已烧录
2. 启动Python服务端
3. 重启ESP32-S3开发板
4. 等待系统初始化完成（查看串口输出）
5. 对着麦克风说"你好小智"
6. 听到欢迎音频后，说出您的指令或问题
7. 等待系统回复

## 支持的本地命令

- "帮我开灯" - 点亮LED灯
- "帮我关灯" - 熄灭LED灯
- "拜拜" - 退出对话模式
- "现在安全屋情况如何" - 自定义命令示例

## 故障排除

### 1. NVS初始化失败 (ESP_ERR_NOT_FOUND)
**问题**：设备启动时出现 `ESP_ERR_NOT_FOUND (0x105)` 错误
**原因**：NVS (Non-Volatile Storage) 分区缺失或未正确配置
**解决方案**：
- 确保分区表包含NVS分区（已在最新版本中修复）
- 如果仍有问题，执行 `idf.py erase-flash` 完全擦除Flash后重新烧录

**NVS说明**：NVS是ESP32的非易失性存储系统，用于存储WiFi配置、系统参数等关键数据。

### 2. WiFi连接失败
- 检查WiFi SSID和密码是否正确
- 确保WiFi网络可用
- 检查ESP32-S3是否在WiFi覆盖范围内

### 3. 无法连接服务端
- 检查服务端IP地址配置是否正确
- 确保服务端已启动并监听8080端口
- 检查防火墙设置

### 4. 语音识别不准确
- 检查麦克风连接是否正确
- 确保环境噪音较小
- 调整麦克风与嘴巴的距离

### 5. 音频播放问题
- 检查功放和扬声器连接
- 确保音频文件完整
- 检查音频参数配置

### 6. VAD语音检测问题
**现象**：语音检测不准确，过早或过晚停止录制
**解决方案**：
- 检查日志中是否显示"VAD模型: 已启用"
- 如果VAD模型加载失败，系统会自动回退到传统静音检测
- 在安静环境下测试，避免背景噪音干扰
- 调整说话音量，确保清晰发音

**VAD模型状态检查**：
- 启动时查看日志："✓ VAD语音活动检测模型初始化成功"
- 如果显示"VAD模型初始化失败"，检查sdkconfig配置中是否启用了`CONFIG_SR_VADN_VADNET1_MEDIUM=y`

## 开发说明

### 添加新的本地命令
1. 在 `custom_commands` 数组中添加新命令
2. 在命令处理逻辑中添加相应的处理代码
3. 重新编译和烧录固件

### 修改音频参数
音频参数在多个地方需要保持一致：
- 采样率：16kHz
- 声道：单声道
- 位深度：16位

### 调试技巧
- 使用 `idf.py monitor` 查看详细的串口输出
- 检查内存使用情况
- 监控WiFi连接状态
- 验证HTTP请求和响应
